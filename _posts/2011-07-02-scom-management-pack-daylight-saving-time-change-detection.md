---
id: 580
title: 'SCOM Management Pack: Daylight Saving Time Change Detection'
date: 2011-07-02T18:29:07+10:00
author: Tao Yang
layout: post
guid: http://blog.tyang.org/?p=580
permalink: /2011/07/02/scom-management-pack-daylight-saving-time-change-detection/
image: /wp-content/uploads/2011/07/DST.jpg
categories:
  - SCOM
tags:
  - Daylight Saving
  - Management Pack
  - SCOM
---
I wrote this management pack to detect system time changes that are caused by daylight saving. It’s called <strong>“Custom Daylight Saving Detection”</strong>.

<strong>Background:</strong>

When supporting a infrastructure that has servers across the globe, it is hard to keep track of daylight saving schedules for all time zones. There is a requirement that we need to be notified when the Windows servers have entered/exited daylight saving time.

<strong>Functionalities:</strong>

This management pack generates alerts when:
<ol>
	<li><strong>the agent computer has entered / exited Daylight Saving time.</strong></li>
	<li><strong>the agent computer is entering / exiting Daylight Saving time within a configurable number of days (default is 10 days).</strong></li>
</ol>
<strong>Inside the Custom Daylight Saving Detection Management Pack:</strong>

This MP consists of 4 rules:

<a href="http://blog.tyang.org/wp-content/uploads/2011/07/image.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="image" src="http://blog.tyang.org/wp-content/uploads/2011/07/image_thumb.png" alt="image" width="580" height="112" border="0" /></a>

&nbsp;
<h2><strong><span style="color: #ff0000; font-size: small;">Rule #1. Compare Current and Previous DaylightInEffect WMI Setting</span></strong></h2>
<strong>Rule Type</strong>: Timed Script

<strong>Schedule</strong>: Runs every hour on 1 minute after full hour on Saturdays and Sundays

<strong>Description</strong>:

The script inside this rule retrieve DaylightInEffect value from Win32_ComputerSystem and compare it with the value previously saved in <strong>&lt;OpsMgr Agent Install Dir&gt;\CustomDST_MP.Control</strong> file. If the current value and the previous value are different, a event with event ID 9999 is logged in Operations Manager event log and CustomDST_MP.Control file is updated to the current value from WMI. This rule only runs during the weekend because daylight savings don’t happen during week days.

<strong>Note</strong>:

1. If CustomDST_MP.Control file does not exist, the script creates it and store the Current DaylightInEffect value in it. therefore there is no pre-configuration required on agent computers.

2. If the script detects the time zone is not impacted by daylight saving, it will skip to the end of the script and CustomDST_MP.Control file is not created on the agent computer.

The event 9999 looks like this:

<a href="http://blog.tyang.org/wp-content/uploads/2011/07/image1.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="image" src="http://blog.tyang.org/wp-content/uploads/2011/07/image_thumb1.png" alt="image" width="580" height="242" border="0" /></a>

(Please note the timing from above example is not correct because for testing purpose, I manually changed the value in the CustomDST_MP.control file.)
<h2><strong><span style="color: #ff0000; font-size: small;">Rule #2. The “Daylight Saving In Effect” Setting has been changed</span></strong></h2>
<strong>Rule Type:</strong> Alert Generating Rule

<strong>Description:</strong> This rule detects the event 9999 from Operations Manager event log that are generated by the previous rule (rule #1). and generates a information alert similar to this:

<a href="http://blog.tyang.org/wp-content/uploads/2011/07/image2.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="image" src="http://blog.tyang.org/wp-content/uploads/2011/07/image_thumb2.png" alt="image" width="579" height="637" border="0" /></a>
<h2><strong><span style="color: #ff0000; font-size: small;">Rule #3. Detect Next Daylight Saving Effect Date and Time</span></strong></h2>
<strong>Rule Type</strong>: Timed Script

<strong>Schedule</strong>: Runs on 12:00am every Monday

<strong>Description</strong>: The script inside this rule detects when (exact date and time) is the agent computer entering or exiting Daylight Saving time. if it is within the configurable number of days (<strong>AlertDayRange</strong>, the default is set to 10 days), an event with event ID 9998 is logged in Operations Manager log. the script works out the exact date and time for the daylight saving time changes and approximate number of days from when the script was run.

Event 9998 looks similar to this:

<a href="http://blog.tyang.org/wp-content/uploads/2011/07/image3.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="image" src="http://blog.tyang.org/wp-content/uploads/2011/07/image_thumb3.png" alt="image" width="580" height="266" border="0" /></a>

<strong>Note</strong>: for testing purpose, I have changed the <strong>AlertDayRange</strong> from 10 to 150 so the alert can be generated. In live environment, please be aware if you change the number to be greater than 14, you will be notified multiple times because the script runs once a week. For the same reason, if you change the number to be smaller than 7, you may not to get notified at all.

<strong>How to change AlertDayRange to a number other than 10?</strong>

To change AlertDayRange from the default of d10 days, simply create an override for this MP for the parameter called “Argument”:

<a href="http://blog.tyang.org/wp-content/uploads/2011/07/image4.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="image" src="http://blog.tyang.org/wp-content/uploads/2011/07/image_thumb4.png" alt="image" width="580" height="597" border="0" /></a>
<h2><span style="color: #ff0000; font-size: small;"><strong>Rule #4. The system time will be changed by Daylight Saving setting soon</strong></span></h2>
<strong>Rule Type:</strong> Alert Generating Rule

<strong>Description:</strong> This rule detects the event 9998 from Operations Manager event log that are generated by the previous rule (rule #3). and generates a information alert similar to this:

<a href="http://blog.tyang.org/wp-content/uploads/2011/07/image5.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="image" src="http://blog.tyang.org/wp-content/uploads/2011/07/image_thumb5.png" alt="image" width="516" height="568" border="0" /></a>

<strong>This management pack can be downloaded </strong><a title="Daylight Saving Management Pack" href="http://blog.tyang.org/wp-content/uploads/2011/07/Daylight_Saving_MP.zip"><strong>here</strong></a><strong>.</strong>

There are 3 files in the zip file. the XML file is the actual management pack (unsealed). the other 2 vbscripts are the actual scripts used in rule #1 and #3 for your reference.