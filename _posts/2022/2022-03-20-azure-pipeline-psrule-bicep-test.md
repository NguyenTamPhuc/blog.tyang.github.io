---
title: Testing Bicep Code Using PSRule in Azure Pipeline
date: 2022-03-20 20:00
author: Tao Yang
permalink: /2022/03/20/azure-pipeline-psrule-bicep-test
summary:
categories:
  - Azure
  - Azure DevOps
tags:
  - Azure DevOps
  - Azure Pipeline
  - Azure Bicep
  - DevOps
  - Infrastructure As Code

---

[PSRule](https://www.powershellgallery.com/packages/PSRule/) is a test and validation tool that can be used to test your Infrastructure as Code (IaC). It works with various supplement modules for different platforms such as Azure, Kubernetes, etc. It is open sourced, maintained by Microsoft's [Bernie White](https://www.linkedin.com/in/bernie-white/). When using it together with its supplement module [PSRule.Rules.Azure](https://www.powershellgallery.com/packages/PSRule.Rules.Azure/), we can validate our ARM and Bicep templates against [over 250 predefined best practices](https://azure.github.io/PSRule.Rules.Azure/en/baselines/Azure.Default/) by Microsoft.

The focus of PSRule is different than the language specific linter such as [ARM-TTK](https://github.com/Azure/arm-ttk) or [Bicep linter](https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/linter) which focus on the language syntax, PSRule is focused on how the resources defined in your IaC code are configured, if the resource configurations align with pre-configured rules. It is a great tool if you are adopting the [Shift-Left](https://devopedia.org/shift-left) approach in DevOps.

I have been playing with PSRule in a customer's environment. With Bernie's help, I have managed to configure it the way I want as part of the Azure Pipelines deploying various Bicep templates.

In my pipelines, I have created a `Test and Build` stage that contains the following steps before deploying the bicep templates to various environments:

1. Install required PSRule modules since I'm using Microsoft-hosted pipeline agents.
2. Using `bicep build` command to compile the bicep code to an ARM template, this step also triggers the[native bicep linter.
3. Validate the ARM template generated by the previous step using PSRule.
4. Publish PSRule test results.
5. Get the What-If result against the bicep template.
6. Run deployment validation against the bicep template.

The sample pipeline and all related code is located in my GitHub repo [bicep.psrule.demo](https://github.com/tyconsulting/bicep.psrule.demo)

![01](../../../../assets/images/2022/03/psrule.bicep-01.jpg)

>**NOTE**: the sample pipeline only contains the `Test and Build' stage. It does not contain any deployment stages.

Few things to note:

**1. [PSRule Azure DevOps extension](https://marketplace.visualstudio.com/items?itemName=bewhite.ps-rule).**

I am using this Azure DevOps extension in my sample code. However, this is not mandatory. You can also use install-module cmdlet to install the `PSRule` and `PSRule.Rules.Azure` modules, and use 'Assert-PSRule' cmdlet to run the PSRule validation.

**2. I am not using PSRule to test Bicep files directly**

Although PSRule supports Bicep files now, I am still testing the ARM template generated by `bicep build` command instead of the bicep files. This is because I am using modules in my Bicep templates and the modules are located in different folders. Based on my testing, when testing the bicep templates directly, the modules are not included. Although I can potentially explicitly test the Bicep modules with PSRule separately, it is easier to just test the compiled ARM template because it consolidates all required modules into Nested deployments.

**3. Custom PSRule baselines defined in the [`.ps-rule'](https://github.com/tyconsulting/bicep.psrule.demo/tree/master/.ps-rule) folder.**

The pipeline YAML template accepts a parameter called [`psRuleBaselineName`](https://github.com/tyconsulting/bicep.psrule.demo/blob/master/pipelines/templates/template-test-and-validate.yml#L19-L22). I have a custom baseline defined for the particular Bicep template. You can customize the PSRule behavior in the baseline. More information about PSRule baselines can be found [here](https://azure.github.io/PSRule.Rules.Azure/working-with-baselines/).

**4. ps-rule.yaml file**

on the root folder of your Git repository, you can create a `ps-rule.yaml` file and set [various options](https://microsoft.github.io/PSRule/v2/concepts/PSRule/en-US/about_PSRule_Options/) in this file. Options configured in this file will be applied to everything within the repo.

Please feel free to give it a try, the [rules for Azure](https://azure.github.io/PSRule.Rules.Azure/en/baselines/Azure.Default/) are updated quarterly. PSRule also provides capability to integrate with Azure Monitor so you can send test results to Azure Monitor via the supplement module [PSRule.Monitor](https://github.com/microsoft/PSRule.Monitor). I have not tried it myself, but it's definitely on my to-do list. Although the sample pipeline is designed for Azure DevOps, PSRule also provides an [action for GitHub Action](https://github.com/marketplace/actions/psrule).
